<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitoreo Distribuido</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f6f8fa; text-align: center; }
        h1 { color: #333; }
        table { margin: 0 auto; border-collapse: collapse; width: 90%; }
        th, td { padding: 10px; border: 1px solid #ccc; }
        tr:nth-child(even) { background: #e8f0ff; }
        .inactivo { color: red; font-weight: bold; }
        .activo { color: green; font-weight: bold; }
        button { padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        canvas { max-width: 700px; margin: 20px auto; display: block; }
        #contenedorHistorial { display: none; background: #fff; padding: 20px; border-radius: 10px; width: 90%; margin: 20px auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h1>Sistema de Monitoreo Distribuido</h1>

    <!-- Tabla -->
    <table>
        <thead>
            <tr><th>Nodo</th><th>CPU (%)</th><th>RAM (%)</th><th>√öltimo reporte</th><th>Estado</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tabla-nodos"></tbody>
    </table>

    <!-- Gr√°fica en tiempo real -->
    <h2>Promedios en Tiempo Real</h2>
    <canvas id="graficaTiempoReal"></canvas>

    <!-- Contenedor de historial -->
    <div id="contenedorHistorial">
        <h2 id="tituloHistorial"></h2>
        <canvas id="graficaHistorialCPU"></canvas>
        <canvas id="graficaHistorialRAM"></canvas>
        <button onclick="cerrarHistorial()">‚ùå Cerrar historial</button>
    </div>

    <script>
        let intervalo;
        let grafTiempoReal;
        let grafHistCPU, grafHistRAM;

        // Inicializa la gr√°fica en tiempo real
        function crearGraficaTiempoReal() {
            const ctx = document.getElementById('graficaTiempoReal').getContext('2d');
            grafTiempoReal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'CPU Promedio (%)', data: [], borderColor: 'orange', tension: 0.3 },
                        { label: 'RAM Promedio (%)', data: [], borderColor: 'green', tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        async function actualizarDatos() {
            const res = await fetch('/status');
            const data = await res.json();
            const cuerpo = document.getElementById('tabla-nodos');
            cuerpo.innerHTML = '';

            let totalCPU = 0;
            let totalRAM = 0;
            let activos = 0;

            for (const nodo in data) {
                const d = data[nodo];
                const estado = d.activo ? 'Activo' : 'Inactivo';
                const clase = d.activo ? 'activo' : 'inactivo';
                cuerpo.innerHTML += `
                    <tr>
                        <td>${nodo}</td>
                        <td>${d.cpu.toFixed(1)}</td>
                        <td>${d.memoria.toFixed(1)}</td>
                        <td>${d.ultimo_reporte}</td>
                        <td class="${clase}">${estado}</td>
                        <td><button onclick="verHistorial('${nodo}')">üìä Ver historial</button></td>
                    </tr>`;

                if (d.activo) {
                    totalCPU += d.cpu;
                    totalRAM += d.memoria;
                    activos++;
                }
            }

            if (activos > 0) {
                const cpuProm = totalCPU / activos;
                const ramProm = totalRAM / activos;
                const tiempo = new Date().toLocaleTimeString();

                if (grafTiempoReal.data.labels.length > 10) {
                    grafTiempoReal.data.labels.shift();
                    grafTiempoReal.data.datasets[0].data.shift();
                    grafTiempoReal.data.datasets[1].data.shift();
                }

                grafTiempoReal.data.labels.push(tiempo);
                grafTiempoReal.data.datasets[0].data.push(cpuProm);
                grafTiempoReal.data.datasets[1].data.push(ramProm);
                grafTiempoReal.update();
            }
        }

        async function verHistorial(nodo) {
            document.getElementById('contenedorHistorial').style.display = 'block';
            const res = await fetch(`/historial/${nodo}`);
            const historial = await res.json();

            document.getElementById('tituloHistorial').innerText = `Historial de ${nodo}`;
            const etiquetas = historial.map(d => d.fecha.split(' ')[1]);
            const datosCPU = historial.map(d => d.cpu);
            const datosRAM = historial.map(d => d.memoria);

            if (grafHistCPU) grafHistCPU.destroy();
            if (grafHistRAM) grafHistRAM.destroy();

            const ctxCPU = document.getElementById('graficaHistorialCPU').getContext('2d');
            const ctxRAM = document.getElementById('graficaHistorialRAM').getContext('2d');

            grafHistCPU = new Chart(ctxCPU, {
                type: 'line',
                data: {
                    labels: etiquetas,
                    datasets: [{ label: 'CPU (%)', data: datosCPU, borderColor: 'orange', tension: 0.3 }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });

            grafHistRAM = new Chart(ctxRAM, {
                type: 'line',
                data: {
                    labels: etiquetas,
                    datasets: [{ label: 'RAM (%)', data: datosRAM, borderColor: 'green', tension: 0.3 }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }

        function cerrarHistorial() {
            document.getElementById('contenedorHistorial').style.display = 'none';
        }

        function iniciarMonitoreo() {
            crearGraficaTiempoReal();
            actualizarDatos();
            intervalo = setInterval(actualizarDatos, 3000);
        }

        iniciarMonitoreo();
    </script>
</body>
</html>
